<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing System</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.min.js"></script>

  
  <!-- QR/Barcode Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 20px 30px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn-header {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-header:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      min-height: 70vh;
    }

    .scanner-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .scanner-header {
      margin-bottom: 20px;
    }

    .scanner-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #444;
    }

    .control-select, .control-input {
      padding: 10px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .control-select:focus, .control-input:focus {
      outline: none;
      border-color: #4facfe;
    }

    .scanner-display {
      text-align: center;
      margin-bottom: 20px;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
    }

    .barcode-reader {
      height: 120px;
    }

    .qr-reader {
      height: 300px;
    }

    .scanner-status {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
    }

    .manual-input {
      display: none;
      margin-top: 15px;
    }

    .manual-input.active {
      display: block;
    }

    .manual-input input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .billing-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    .customer-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 10px;
    }

    .scanned-items {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
      margin-bottom: 20px;
    }

    .item-card {
      background: #f8fafc;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      color: #2c5aa0;
      margin-bottom: 4px;
    }

    .item-details {
      font-size: 0.9rem;
      color: #666;
    }

    .item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .qty-btn {
      background: #f0f0f0;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .qty-btn:hover {
      background: #e0e0e0;
    }

    .qty-input {
      border: none;
      width: 50px;
      text-align: center;
      padding: 6px;
    }

    .item-amount {
      font-weight: 700;
      color: #2c5aa0;
      font-size: 1.1rem;
    }

    .totals-summary {
      background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .grand-total {
      font-weight: 700;
      font-size: 1.3rem;
      color: #2c5aa0;
      border-top: 2px solid #4facfe;
      padding-top: 10px;
      margin-top: 10px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .full-bill-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      margin: 20px auto;
      padding: 30px;
      border-radius: 15px;
      max-width: 800px;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #666;
    }

    .bill-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    .bill-table th {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .bill-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #e1e8ed;
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 2000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .alert.show {
      transform: translateX(0);
    }

    .alert.success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }

    .alert.error {
      background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    }

    @media print {
      body * {
        visibility: hidden;
      }
      
      .modal-content, .modal-content * {
        visibility: visible;
      }
      
      .modal-content {
        position: absolute;
        left: 0;
        top: 0;
        margin: 0;
        padding: 20px;
        box-shadow: none;
        border-radius: 0;
      }
      
      .modal-header button,
      .action-buttons {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .scanner-controls {
        grid-template-columns: 1fr;
      }
      
      .customer-info {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 15px 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .header-actions {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõí Billing System</h1>
      <div class="header-actions">
	<button class="btn-header" onclick="location.reload();">
          üìÑ New Bill
        </button>
        <button class="btn-header" onclick="window.open('salesBillGeneration.html', '_blank')">
          üìÑ Another Bill
        </button>
        <button class="btn-header" onclick="showSettings()">
          ‚öôÔ∏è Settings
        </button>
        <span id="sessionInfo">Session: Default</span>
      </div>
    </div>

    <div class="main-content">
      <!-- Scanner Section -->
      <div class="scanner-section" id="scanFullSec" >

      <div id="scanSec" >
        <div class="scanner-header">
          <h2>üì∑ Product Scanner</h2>
        </div>

        <div class="scanner-controls">
          <div class="control-group">
            <label for="scanType">Scan Type</label>
            <select id="scanType" class="control-select" onchange="changeScanType()">
              <option value="qr">QR Code</option>
              <option value="barcode">Barcode</option>
              <option value="manual">Manual Entry</option>
            </select>
          </div>
          
          <div class="control-group">
            <label for="inputMethod">Input Method</label>
            <select id="inputMethod" class="control-select">
              <option value="camera">Camera</option>
              <option value="bluetooth">Bluetooth Scanner</option>
              <option value="wifi">WiFi Scanner</option>
              <option value="usb">USB Scanner</option>
            </select>
          </div>
        </div>
        </div>

        <div class="scanner-display" id="scanArea" style="display: none;">
          <div id="reader" class="qr-reader"></div>
          
          <div class="manual-input" id="manualInput">
            <input type="text" id="manualCode" placeholder="Enter barcode/QR code manually" 
                   onkeypress="handleManualEntry(event)">
            <button class="btn btn-primary" onclick="processManualEntry()">
              ‚úì Add Product
            </button>
          </div>
        </div>

        <div class="scanner-status" id="scanStatus">
          <strong>Ready to scan</strong><br>
          <em>Point camera at QR code or barcode</em>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn btn-success" id="startBtn" onclick="startScanner()">
            ‚ñ∂Ô∏è Start Scanner
          </button>
          <button class="btn btn-danger" id="stopBtn" onclick="stopScanner()" disabled>
            ‚èπÔ∏è Stop Scanner
          </button>
        </div>
      </div>

      <!-- Billing Section -->
      <div class="billing-section">

     <!--   <div class="customer-info" style="display: none;" id="custInfo">
          <div class="control-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" class="control-input" placeholder="Enter customer name">
          </div>
          <div class="control-group">
            <label for="customerPhone">Phone Number</label>
            <input type="tel" id="customerPhone" class="control-input" placeholder="Enter phone number">
          </div>
        </div>
-->
        <div class="scanned-items" id="scannedItems">
          <div class="empty-state">
            <h3>üì¶ No items scanned yet</h3>
            <p>Start scanning to add products</p>
          </div>
        </div>

        <div class="totals-summary" id="totalsSummary" style="display: none;">
          <div class="total-row">
            <span>Items Count:</span>
            <span id="itemCount">0</span>
          </div>
          <div class="total-row">
            <span>Subtotal:</span>
            <span>‚Çπ<span id="subtotalAmount">0.00</span></span>
          </div>
          <div class="total-row">
            <span>Discount:</span>
            <span>‚Çπ<span id="discountAmount">0.00</span></span>
          </div>
          <div class="total-row">
            <span>GST:</span>
            <span>‚Çπ<span id="gstAmount">0.00</span></span>
          </div>
          <div class="total-row grand-total">
            <span>Grand Total:</span>
            <span>‚Çπ<span id="grandTotalAmount">0.00</span></span>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="billFinalise()" id="viewBillBtn">
            üìã Bill Finalise
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            üóëÔ∏è Clear All
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Full Bill Modal -->
  <div class="full-bill-modal" id="fullBillModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìÑ Sales Invoice</h2>
        <button class="close-modal" onclick="closeFullBill()">&times;</button>
      </div>
      
      <div id="fullBillContent">
        <!-- Bill content will be generated here -->
      </div>

      <div class="action-buttons" style="margin-top: 30px;">
        <button class="btn btn-primary" onclick="printBill()">
          üñ®Ô∏è Print Bill
        </button>
        <button class="btn btn-success" onclick="saveBill()">
          üíæ Save Bill
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWmCyJepagKmTy5kfBCOdaGKmcOymj4zg",
      authDomain: "sunivox.firebaseapp.com",
      projectId: "sunivox",
      storageBucket: "sunivox.firebasestorage.app",
      messagingSenderId: "866107015527",
      appId: "1:866107015527:web:2c0733694e797dd7586fc2",
      measurementId: "G-06NVXJVKV2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global Variables

    let scannerActive = false;
    let invoiceItems = [];
    let grandTotalFinal = 10;
    let session = new URLSearchParams(location.search).get("session") || "defaultSession";
    
    // Audio for scan feedback
    const beep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    beep.preload = 'auto';

    // Create scanner
    const html5QrCode = new Html5Qrcode("reader");

    // Initialize
    document.getElementById('sessionInfo').textContent = `Session: ${session}`;

    // Scanner Functions
    function changeScanType() {
      const scanType = document.getElementById('scanType').value;
      const reader = document.getElementById('reader');
      const manualInput = document.getElementById('manualInput');
      
      if (scanType === 'manual') {
        reader.style.display = 'none';
        manualInput.classList.add('active');
        if (scannerActive) {
          stopScanner();
        }
      } else {
        reader.style.display = 'block';
        manualInput.classList.remove('active');
        
        // Adjust scanner box size
        if (scanType === 'barcode') {
          reader.className = 'barcode-reader';
        } else {
          reader.className = 'qr-reader';
        }
      }
    }

  /*  function startScanner() {
      if (document.getElementById('scanType').value === 'manual') {
        document.getElementById('manualCode').focus();
        return;
      }

      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }

      const scanType = document.getElementById('scanType').value;
      const config = {
        fps: 10,
        qrbox: scanType === 'barcode' ? { width: 250, height: 100 } : { width: 250, height: 250 },
        aspectRatio: scanType === 'barcode' ? 2.5 : 1.0
      };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanError
      ).then(() => {
        scannerActive = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        updateScanStatus("Scanner active - Ready to scan", "success");
      }).catch(err => {
        showAlert("Camera start error: " + err, "error");
      });
    }
  */


function startScanner() {
  // Clear the 'value' field in Firestore
  db.collection("scans").doc(session).set({
    value: null
  }, { merge: true }) // merge ensures other fields are not overwritten
  .then(() => {
    alert("Ready to start scanner.");
    scannerActive = true; 
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('startBtn').disabled = true;
    updateScanStatus("Scanner active - Ready to scan", "success");
    document.getElementById('scanSec').style.display = 'none';
    document.getElementById('scanArea').style.display = 'block';

    html5QrCode.start(
      { facingMode: "environment" }, // rear camera
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      onScanSuccess,
      (errorMessage) => {
        // Ignore scan errors
      }
    ).catch(err => {
      alert("Camera start error: " + err);
    });

  }).catch((error) => {
    alert("Firestore update error: " + error);
  });
}



    function stopScanner() { 
    if (html5QrCode && scannerActive) { 
        html5QrCode.stop().then(() => { 
          scannerActive = false;
          document.getElementById('startBtn').disabled = false;
          document.getElementById('stopBtn').disabled = true;
          updateScanStatus("Scanner stopped", "info");
        });
      }
//  document.getElementById('custInfo').style.display = 'block';
  document.getElementById('scanFullSec').style.display = 'none';

 }

    function onScanSuccess(decodedText, decodedResult) {
      if (!scannerActive) return;
      
      html5QrCode.pause();
      beep.currentTime = 0;
      beep.play();
      
      updateScanStatus(`Scanned: ${decodedText} - Looking up product...`, "processing");
      
      // Look up product in database
      lookupProduct(decodedText);
      
      // Resume scanning after delay
      setTimeout(() => {
        if (scannerActive && html5QrCode) {
          html5QrCode.resume();
        }
      }, 2000);
    }

/*
function onScanSuccess(decodedText, decodedResult) {
      // Pause scanning
      html5QrCode.pause();

      // Play beep immediately
      beep.currentTime = 0;
      beep.play();

      // Write to Firestore
      db.collection("scans").doc(session).set({
        value: decodedText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log("‚úÖ Data sent: " + decodedText);
      }).catch((error) => {
        alert("‚ùå Firestore Error: " + error);
      }).finally(() => {
        // Resume scanning after 1.5 seconds
        setTimeout(() => {
          html5QrCode.resume();
        }, 1500);
      });
    }
*/


    function onScanError(error) {
      // Ignore scan errors (too frequent)
    }

    function handleManualEntry(event) {
      if (event.key === 'Enter') {
        processManualEntry();
      }
    }

    function processManualEntry() {
      const code = document.getElementById('manualCode').value.trim();
      if (code) {
        lookupProduct(code);
        document.getElementById('manualCode').value = '';
      }
    }

    function lookupProduct(code) {
      db.collection("products").doc(code).get()
        .then((docSnap) => {
          if (docSnap.exists) {
            const product = docSnap.data();
            addItemToInvoice(code, product);
            updateScanStatus(`‚úÖ Added: ${product.name}`, "success");
            beep.play();
          } else {
            updateScanStatus(`‚ùå Product not found: ${code}`, "error");
            showAlert("Product not found in database", "error");
          }
        })
        .catch((error) => {
          updateScanStatus(`‚ùå Error: ${error.message}`, "error");
          showAlert("Error fetching product data", "error");
        });
    }

    function updateScanStatus(message, type) {
      const statusEl = document.getElementById('scanStatus');
      statusEl.innerHTML = `<strong>${message}</strong>`;
      
      // Add visual feedback based on type
      statusEl.className = 'scanner-status';
      if (type === 'success') {
        statusEl.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        statusEl.style.color = '#155724';
      } else if (type === 'error') {
        statusEl.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        statusEl.style.color = '#721c24';
      } else {
        statusEl.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
        statusEl.style.color = '#333';
      }
    }

    // Billing Functions
    function addItemToInvoice(barcode, product) {
      const existingItemIndex = invoiceItems.findIndex(item => item.barcode === barcode);
      
      if (existingItemIndex > -1) {
        invoiceItems[existingItemIndex].quantity += 1;
        showAlert(`Increased quantity of ${product.name}`, "success");
      } else {
        const item = {
          barcode: barcode,
          name: product.name,
          brand: product.brand || 'N/A',
          category: product.category || 'General',
          hsnCode: product.hsnCode || '0000',
          mrp: parseFloat(product.mrp) || 0,
          gstRate: parseFloat(product.gstRate) || 0,
          discount: parseFloat(product.discount) || 0,
          unit: product.unit || 'pcs',
          quantity: 1
        };
        invoiceItems.push(item);
        showAlert(`Added ${product.name} to invoice`, "success");
      }
      
      renderScannedItems();
      updateTotals();
    }

    function renderScannedItems() {
      const container = document.getElementById('scannedItems');
      
      if (invoiceItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>üì¶ No items scanned yet</h3>
            <p>Start scanning to add products</p>
          </div>
        `;
        document.getElementById('viewBillBtn').disabled = true;
        return;
      }

      container.innerHTML = invoiceItems.map((item, index) => {
        const amounts = calculateItemAmount(item);
        return `
          <div class="item-card">
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              <div class="item-details">${item.brand} | ${item.unit} | ‚Çπ${item.mrp.toFixed(2)}</div>
            </div>
            <div class="item-controls">
              <div class="quantity-control">
                <button class="qty-btn" onclick="updateQuantity(${index}, ${item.quantity - 1})">-</button>
                <input type="number" class="qty-input" value="${item.quantity}" 
                       onchange="updateQuantity(${index}, this.value)" min="1">
                <button class="qty-btn" onclick="updateQuantity(${index}, ${item.quantity + 1})">+</button>
              </div>
              <div class="item-amount">‚Çπ${amounts.totalAmount.toFixed(2)}</div>
              <button class="btn-danger" style="padding: 6px 10px; font-size: 0.8rem;" 
                      onclick="removeItem(${index})">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('viewBillBtn').disabled = false;
    }

    function updateQuantity(index, quantity) {
      const qty = parseInt(quantity);
      if (qty <= 0) {
        removeItem(index);
        return;
      }
      invoiceItems[index].quantity = qty;
      renderScannedItems();
      updateTotals();
    }

    function removeItem(index) {
      const itemName = invoiceItems[index].name;
      invoiceItems.splice(index, 1);
      renderScannedItems();
      updateTotals();
      showAlert(`Removed ${itemName}`, "success");
    }

    function calculateItemAmount(item) {
      const baseAmount = item.mrp * item.quantity;
      const discountAmount = (baseAmount * item.discount) / 100;
      const taxableAmount = baseAmount - discountAmount;
      const gstAmount = (taxableAmount * item.gstRate) / 100;
      const totalAmount = taxableAmount + gstAmount;
      
      return {
        baseAmount,
        discountAmount,
        taxableAmount,
        gstAmount,
        totalAmount
      };
    }



function updateTotals() {
  const summaryEl = document.getElementById('totalsSummary');
  
  if (invoiceItems.length === 0) {
    summaryEl.style.display = 'none';
    return;
  }

  summaryEl.style.display = 'block';

  let itemCount = 0;
  let subtotal = 0;
  let totalDiscount = 0;
  let totalGST = 0;
  let grandTotal = 0;

  invoiceItems.forEach(item => {
    const amounts = calculateItemAmount(item);
    itemCount += item.quantity;
    subtotal += amounts.baseAmount;
    totalDiscount += amounts.discountAmount;
    totalGST += amounts.gstAmount;
    grandTotal += amounts.totalAmount;
  });

  document.getElementById('itemCount').textContent = itemCount;
  document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
  document.getElementById('discountAmount').textContent = totalDiscount.toFixed(2);
  document.getElementById('gstAmount').textContent = totalGST.toFixed(2);
  document.getElementById('grandTotalAmount').textContent = grandTotal.toFixed(2);

  grandTotalFinal=parseFloat(grandTotal);
}


function showAlert(message, type = "success") {
    // Inject CSS only once
    if (!document.getElementById("custom-alert-style")) {
        const style = document.createElement("style");
        style.id = "custom-alert-style";
        style.textContent = `
            .custom-alert {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #4caf50;
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease, transform 0.2s ease;
                z-index: 9999;
                font-size: 14px;
            }
            .custom-alert.error {
                background-color: #f44336;
            }
            .custom-alert.show {
                opacity: 1;
                pointer-events: auto;
                transform: translateX(-50%) translateY(10px);
            }
        `;
        document.head.appendChild(style);
    }

    // Create alert div
    const alert = document.createElement("div");
    alert.className = `custom-alert ${type}`;
    alert.innerText = message;

    document.body.appendChild(alert);

    // Force reflow
    void alert.offsetWidth;
    alert.classList.add("show");

    // Remove after 2 seconds
    setTimeout(() => {
        alert.classList.remove("show");
        setTimeout(() => alert.remove(), 200);
    }, 2000);
}



function askPhoneNumber() {
  return new Promise((resolve) => {
    if (document.getElementById("phonePromptOverlay")) return;

    const overlay = document.createElement("div");
    overlay.id = "phonePromptOverlay";
    overlay.style = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;

    const popup = document.createElement("div");
    popup.style = `
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      text-align: center;
      font-family: sans-serif;
      position: relative;
    `;

    popup.innerHTML = `
      <span id="closeBtn" style="
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        color: red;
        font-weight: bold;
      ">&times;</span>
      <h3 style="margin-bottom: 15px;">Enter Phone Number</h3>
      <input type="tel" id="phoneInputBox" maxlength="10"
             placeholder="10-digit number"
             style="padding: 10px; width: 200px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; outline: none;" />
      <br/><br/>
      <button id="phoneSubmitBtn" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
        Submit
      </button>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    const input = document.getElementById("phoneInputBox");
    const button = document.getElementById("phoneSubmitBtn");
    const closeBtn = document.getElementById("closeBtn");

    const closePopup = (value = null) => {
      document.body.removeChild(overlay);
      resolve(value); // return null or phone number
    };

    const submit = () => {
      const value = input.value.trim();
      if (/^\d{10}$/.test(value)) {
        closePopup(value);
      } else {
        showAlert("Please enter a valid 10-digit number.", "error");
      }
    };

    button.onclick = submit;
    closeBtn.onclick = () => closePopup(null);
    input.onkeydown = (e) => {
      if (e.key === "Enter") submit();
    };

    // Restrict input to digits only
    input.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    input.focus();
  });
}


function selectPaymentMode() {
  return new Promise((resolve) => {
    if (document.getElementById("paymentPromptOverlay")) return;

    const overlay = document.createElement("div");
    overlay.id = "paymentPromptOverlay";
    overlay.style = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;

    const popup = document.createElement("div");
    popup.style = `
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      text-align: left;
      font-family: sans-serif;
      position: relative;
      width: 280px;
    `;

    popup.innerHTML = `
      <span id="closePaymentBtn" style="
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        color: red;
        font-weight: bold;
      ">&times;</span>
      <h3 style="margin-bottom: 15px;">Select Payment Mode</h3>
      <div style="display: flex; flex-direction: column; gap: 10px; font-size: 16px;">
        <label><input type="radio" name="paymentMode" value="UPI" checked> UPI</label>
        <label><input type="radio" name="paymentMode" value="Cash"> Cash</label>
        <label><input type="radio" name="paymentMode" value="Card"> Card</label>
        <label><input type="radio" name="paymentMode" value="Others"> Others</label>
      </div>
      <br/>
      <button id="paymentSubmitBtn" style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
        Submit
      </button>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    const closeBtn = document.getElementById("closePaymentBtn");
    const submitBtn = document.getElementById("paymentSubmitBtn");

    const closePopup = (value = null) => {
      document.body.removeChild(overlay);
      resolve(value); // null if cancelled, or selected payment mode
    };

    const submit = () => {
      const selected = document.querySelector('input[name="paymentMode"]:checked');
      if (selected) {
        closePopup(selected.value);
      } else {
        showAlert("Please select a payment mode.", "error");
      }
    };

    closeBtn.onclick = () => closePopup(null);
    submitBtn.onclick = submit;
  });
}




function showUPIPaymentPopup(grandTotalFinal) {
  if (document.getElementById('upiOverlay')) return;

  const upiID = "sunilskutan@oksbi";
  const merchantName = "Sunil.S";
  const upiLink = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(merchantName)}&am=${grandTotalFinal.toFixed(2)}&cu=INR&tn=${encodeURIComponent('Customer')}`;

  // Create overlay
  const overlay = document.createElement("div");
  overlay.id = "upiOverlay";
  overlay.style = `
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;

  // Create popup container
  const popup = document.createElement("div");
  popup.style = `
    background: white;
    padding: 20px 25px;
    border-radius: 10px;
    text-align: center;
    max-width: 90%;
    width: 300px;
    font-family: sans-serif;
    position: relative;
  `;

  // Close button
  const closeBtn = document.createElement("span");
  closeBtn.textContent = "√ó";
  closeBtn.style = `
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    color: red;
  `;
  closeBtn.onclick = () => document.body.removeChild(overlay);
  popup.appendChild(closeBtn);

  // Heading
  const heading = document.createElement("h3");
  heading.textContent = "Scan to Pay";
  popup.appendChild(heading);

  // Amount display
  const amountText = document.createElement("p");
  amountText.textContent = `Amount: ‚Çπ${grandTotalFinal.toFixed(2)}`;
  amountText.style = "font-weight: bold; font-size: 16px;";
  popup.appendChild(amountText);

  // QR code container
  const qrDiv = document.createElement("div");
  qrDiv.id = "qrcode-popup";
  qrDiv.style = "margin: 10px 0;";
  popup.appendChild(qrDiv);

  // Payment link
  const payLink = document.createElement("a");
  payLink.id = "payLink-popup";
  payLink.href = upiLink;
  payLink.textContent = "Open UPI App";
  payLink.style = "display: inline-block; margin-top: 10px; color: blue; text-decoration: underline; font-size: 14px;";
  payLink.onclick = function (e) {
    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      window.location.href = upiLink;
    } else {
      alert("Scan the QR code using your UPI app.");
      e.preventDefault();
    }
  };
  popup.appendChild(payLink);

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  // Generate QR Code
  try {
    const qr = qrcode(0, 'M');
    qr.addData(upiLink);
    qr.make();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const cellSize = 4;
    const margin = 10;
    const size = qr.getModuleCount();
    canvas.width = canvas.height = size * cellSize + margin * 2;

    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#000';
    for (let row = 0; row < size; row++) {
      for (let col = 0; col < size; col++) {
        if (qr.isDark(row, col)) {
          ctx.fillRect(col * cellSize + margin, row * cellSize + margin, cellSize, cellSize);
        }
      }
    }

    qrDiv.appendChild(canvas);
  } catch (err) {
    qrDiv.innerHTML = `<p>QR generation failed. UPI Link: ${upiLink}</p>`;
  }
}

function billFinalise() {
  askPhoneNumber().then((phone) => {
    if (!phone) {
      showAlert("Phone input canceled.", "error");
      return;
    }

    // Proceed to select payment mode
    selectPaymentMode().then((mode) => {
      if (!mode) {
        showAlert("Payment Mode selection cancelled.", "error");
        return;
      }

      // If payment mode is UPI, show UPI QR popup
      if (mode.toLowerCase() === "upi") {
        showUPIPaymentPopup(grandTotalFinal);
      }

      // Optional: handle other modes like Cash/Card
      console.log("Phone:", phone, "Mode:", mode);
      // showAlert(`Phone: ${phone}, Mode: ${mode}`, "success");
    });
  });
}

    </script>
</body>
</html>
